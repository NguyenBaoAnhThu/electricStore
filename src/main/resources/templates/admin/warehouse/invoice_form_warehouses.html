<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Phiếu Nhập Kho</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Styles -->
  <link rel="stylesheet" th:href="@{/css/admin/fragments/sidebar.css}">
  <link rel="stylesheet" th:href="@{/css/admin/fragments/header.css}">
  <link rel="stylesheet" th:href="@{/css/admin/layout/layout.css}">
  <link rel="stylesheet" th:href="@{/css/admin/layout/tablelayout.css}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">

  <style>
    .red-bar { background-color: #dc3545; width: 4px; height: 100%; position: absolute; left: 0; top: 0; }
    .form-container { background-color: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; position: relative; }
    .product-table th { background-color: #212529; color: white; text-align: center; }
    .product-table td { vertical-align: middle; text-align: center; }
  </style>
</head>
<body>

<!-- Header + Sidebar -->
<div th:replace="~{admin/fragments/header :: header}"></div>
<div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>

<main class="main-content" id="invoiceContent">
  <div class="wrapper">
    <!-- Title & Actions -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="me-3">Phiếu Nhập Kho - <span th:text="${invoice.receiptCode}"></span></h3>
      <span class="badge px-3 py-2"
            th:classappend="
              ${invoice.products[0].paymentStatus == 'ĐÃ THANH TOÁN'} ? 'bg-success' :
              (${invoice.products[0].paymentStatus == 'ĐÃ HỦY'} ? 'bg-danger' :
              (${invoice.products[0].paymentStatus == 'ĐANG TIẾN HÀNH'} ? 'bg-warning text-dark' : 'bg-secondary'))"
            th:text="${invoice.products[0].paymentStatus}">
      </span>

      <div>
        <button class="btn btn-secondary me-2">  <a class=" btn-secondary" th:href="@{/Admin/ware-houses/history_warehouse}"> Quay Lại</a>  </button>
        <button th:if="${invoice.products[0].paymentStatus != 'ĐÃ HỦY' and invoice.products[0].paymentStatus != 'ĐÃ THANH TOÁN'}" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#paymentModal">Thanh Toán</button>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button">Thông Tin</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment" type="button">Lịch Sử Thanh Toán</button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mb-4" id="myTabContent">
      <!-- Thông Tin Tab -->
      <div class="tab-pane fade show active" id="info" role="tabpanel">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Mã Phiếu Nhập</label>
            <input type="text" class="form-control" value="NK001" disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ngày Nhập Kho</label>
            <input type="date"  th:value="${invoice.getImportDate()}" class="form-control"/>
          </div>
          <div class="col-md-3">
            <label class="form-label">Nhà Cung Cấp</label>
            <input type="text" class="form-control"  placeholder="Nhập tên NCC">
          </div>
          <div class="col-md-3">
            <label class="form-label">Ghi Chú</label>
            <input type="text" th:value="${invoice.getNotes()}" class="form-control"/>
          </div>
        </div>
      </div>

      <!-- Lịch Sử Thanh Toán Tab -->
      <div class="tab-pane fade" id="payment" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
            <tr>
              <th>Ngày Thanh Toán</th>
              <th>Phương Thức</th>
              <th>Số Tiền</th>
            </tr>
            </thead>
            <tbody id="paymentHistoryBody">
            <!-- JS đổ dữ liệu vào đây -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Bảng Sản Phẩm -->
    <div class="table-responsive mb-4">
      <table class="table table-bordered product-table">
        <thead>
        <tr>
          <th>STT</th>
          <th>Mã SP</th>
          <th>Tên Sản Phẩm</th>
          <th>Thương Hiệu</th>
          <th>Số Lượng</th>
          <th>Đơn Giá</th>
          <th>Thành Tiền</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item, stat : ${invoice.products}">
          <td th:text="${stat.index + 1}"></td>
          <td th:text="${item.productCode}"></td>
          <td th:text="${item.productName}"></td>
          <td th:text="${item.brand}"></td>
          <td th:text="${item.quantity}"></td>
          <td th:text="${#numbers.formatDecimal(item.price, 0, 'POINT', 0, 'COMMA')}"></td>
          <td th:text="${#numbers.formatDecimal(item.quantity * item.price, 0, 'POINT', 0, 'COMMA')}"></td>

        </tr>
        </tbody>
      </table>
    </div>

    <!-- Tổng Giá Trị -->
    <div class="row mb-3">
      <div class="col-md-6">
        <h5>Giá Trị Nhập</h5>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between">
            <span>Tổng Sản Phẩm</span><strong th:text="${invoice.products.size()}"></strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Giảm Giá</span><strong th:text="${invoice.discount} + ' VNĐ'"></strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Phí Khác</span><strong th:text="${invoice.additionalFees} + ' VNĐ'"></strong>
          </li>
        </ul>
      </div>
      <div class="col-md-6">
        <h5>Tổng Giá Trị Nhập Hàng</h5>
        <div class="bg-light p-3 rounded text-end">
          <h4 class="text-danger" th:text="${#numbers.formatDecimal(total, 0, 'POINT', 0, 'COMMA')} + ' VNĐ'"></h4>
        </div>
      </div>
    </div>

    <div class="text-end mb-5">
      <button class="btn btn-warning me-2" id="exportPdfButton">Lưu Phiếu</button>
      <button th:if="${invoice.products[0].paymentStatus != 'ĐÃ HỦY' and invoice.products[0].paymentStatus != 'ĐÃ THANH TOÁN'}"
              type="button"
              class="btn btn-danger me-2"
              data-bs-toggle="modal"
              data-bs-target="#cancelModal">
        Hủy Phiếu
      </button>
    </div>
  </div>
</main>

<!-- Modal Thanh Toán -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white py-2">
        <h5 class="modal-title" id="paymentModalLabel">Thanh Toán Hóa Đơn Nhập Hàng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <p class="fw-bold">Tổng giá trị nhập hàng:</p>
        <p>Đã thanh toán: <span class="text-success">0 VNĐ</span></p>
        <p>Còn nợ: <span class="text-danger" th:text="${#numbers.formatDecimal(total, 0, 'POINT', 0, 'COMMA')} + ' VNĐ'"></span></p>

        <form id="paymentForm">
          <input type="hidden" id="invoiceId" th:value="${invoice.id}" />
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="paymentMethod" id="cashOption" value="cash" checked>
            <label class="form-check-label" for="cashOption">Tiền mặt</label>
            <input id="cashAmount" type="text" class="form-control mt-1" placeholder="Nhập số tiền">
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="paymentMethod" id="bankOption" value="bank">
            <label class="form-check-label" for="bankOption">Chuyển Khoản</label>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="paymentMethod" id="cardOption" value="card">
            <label class="form-check-label" for="cardOption">Quẹt Thẻ</label>
          </div>

          <div class="text-end">
            <p class="fw-bold mb-2">Tổng Tiền Thanh Toán: <span class="text-primary" id="totalDebt"></span></p>
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Hủy</button>
            <button type="submit" class="btn btn-primary">Thanh Toán</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-secondary">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="cancelModalLabel">Xác nhận hủy phiếu</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3"><strong>⚠️ Bạn có chắc chắn muốn hủy phiếu nhập kho này không?</strong><br>
          Phiếu đã hủy sẽ không thể tiếp tục xử lý.
        </p>
        <div class="mb-3">
          <label for="cancelReason" class="form-label">Vui lòng nhập lý do Hủy phiếu:</label>
          <input type="text" class="form-control" id="cancelReason" placeholder="Nhập lý do...">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-danger" onclick="confirmCancel()">Xác Nhận</button>
      </div>
    </div>
  </div>
</div>


<!-- Footer -->
<div th:replace="~{admin/fragments/footer :: footer}"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const invoiceId = document.getElementById("invoiceId").value;
    const storageKey = `invoice-paid-${invoiceId}`;
    const paymentHistoryKey = `payment-history-${invoiceId}`;
    const paymentStatus = document.querySelector(".badge").textContent.trim();

    const paidAmount = Number(localStorage.getItem(storageKey) || 0);

    const paidDisplay = document.createElement("li");
    paidDisplay.className = "list-group-item d-flex justify-content-between";
    paidDisplay.innerHTML = `<span>Đã Thanh Toán</span><strong>${paidAmount.toLocaleString('vi-VN')} VNĐ</strong>`;
    const listGroup = document.querySelector(".list-group");
    listGroup.appendChild(paidDisplay);

    const total = Number(document.querySelector('h4.text-danger').textContent.replace(/[^\d]/g, ''));
    const remaining = total - paidAmount;
    document.querySelector("#paymentModal .text-success").textContent = `${paidAmount.toLocaleString('vi-VN')} VNĐ`;
    document.querySelector("#paymentModal .text-danger").textContent = `${remaining.toLocaleString('vi-VN')} VNĐ`;
    document.getElementById("totalDebt").textContent = `${remaining.toLocaleString('vi-VN')} VNĐ`;

    renderPaymentHistory(invoiceId);

    document.getElementById("paymentForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const amount = Number(document.getElementById("cashAmount").value);
      if (!amount || amount <= 0) {
        alert("Vui lòng nhập số tiền hợp lệ!");
        return;
      }

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
      const invoiceId = document.getElementById("invoiceId").value;
      const paidAt = new Date().toISOString();

      // Gửi lịch sử thanh toán vào API
      await fetch("/api/payment-history", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ invoiceId, method: paymentMethod, amount, paidAt })
      });

      // Gửi cập nhật số tiền tổng nếu cần
      const res = await fetch("/payment/invoice/payment", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ invoiceId, amountPaid: amount })
      });

      const msg = await res.text();
      alert(msg);
      window.location.href = "/Admin/ware-houses/history_warehouse";
    });

    const exportButton = document.getElementById('exportPdfButton');
    const invoiceElement = document.getElementById('invoiceContent');
    const invoiceCode = document.querySelector('h3 span').textContent || 'hoa-don';

    if (exportButton && invoiceElement) {
      exportButton.addEventListener('click', () => {
        console.log('Bắt đầu xuất PDF...');
        exportButton.disabled = true;
        exportButton.textContent = 'Đang xử lý...';

        const { jsPDF } = window.jspdf;

        html2canvas(invoiceElement, {
          scale: 2,
          useCORS: true
        }).then(canvas => {
          console.log('Đã chụp ảnh màn hình xong.');
          const imgData = canvas.toDataURL('image/png');

          // Tính toán kích thước PDF và ảnh
          const pdf = new jsPDF({
            orientation: 'p', // 'p' for portrait, 'l' for landscape
            unit: 'mm',        // đơn vị: mm
            format: 'a4'       // khổ giấy A4
          });

          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          const canvasWidth = canvas.width;
          const canvasHeight = canvas.height;
          const ratio = canvasWidth / canvasHeight;

          let imgWidth = pdfWidth - 20;
          let imgHeight = imgWidth / ratio;


          let heightLeft = imgHeight;
          let position = 10;


          pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
          heightLeft -= (pdfHeight - 20);

          while (heightLeft > 0) {
            position = position - pdfHeight + 20;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= (pdfHeight - 20);
          }

          console.log('Đang lưu file PDF...');
          pdf.save(`${invoiceCode}.pdf`);

          console.log('Xuất PDF thành công!');
          exportButton.disabled = false;
          exportButton.textContent = 'Lưu phiếu';

        }).catch(error => {
          console.error('Lỗi khi xuất PDF:', error);
          alert('Đã xảy ra lỗi khi tạo file PDF. Vui lòng thử lại.');
          exportButton.disabled = false;
          exportButton.textContent = 'Lưu phiếu';
        });
      });
    }

    async function renderPaymentHistory(invoiceId) {
      const res = await fetch(`/api/payment-history?invoiceId=${invoiceId}`);
      const historyList = await res.json();

      const tbody = document.getElementById("paymentHistoryBody");
      tbody.innerHTML = "";

      if (!historyList.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">Chưa có dữ liệu thanh toán.</td></tr>`;
        return;
      }

      historyList.forEach(entry => {
        const row = document.createElement("tr");
        const paidDate = new Date(entry.paidAt).toLocaleString("vi-VN");
        row.innerHTML = `
      <td>${paidDate}</td>
      <td>${entry.method}</td>
      <td>${Number(entry.amount).toLocaleString('vi-VN')} VNĐ</td>
    `;
        tbody.appendChild(row);
      });
    }
  });

  async function confirmCancel() {
    const invoiceId = document.getElementById("invoiceId").value;
    const reason = document.getElementById("cancelReason").value.trim();

    if (reason === "") {
      alert("Vui lòng nhập lý do hủy phiếu!");
      return;
    }

    const res = await fetch("/api/Admin/invoice/cancel", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({
        invoiceId: invoiceId
      })
    });

    const msg = await res.text();
    alert(msg);
    window.location.href = "/Admin/ware-houses/history_warehouse";
  }
</script>

</body>
</html>
